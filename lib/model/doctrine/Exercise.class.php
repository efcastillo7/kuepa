<?php

/**
 * Exercise
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 * 
 * @package    kuepa
 * @subpackage model
 * @author     fiberbunny
 * @version    SVN: $Id: Builder.php 7490 2010-03-29 19:53:27Z jwage $
 */
class Exercise extends BaseExercise {

    public static function getRepository() {
        return Doctrine_Core::getTable('Exercise');
    }

    public function evaluate($keyvalueanswers) {
        //recibe un array de $question_id => $answervalue
        $questions = $this->getQuestions();
        $score = array();
        $total_score = 0;

        foreach ($questions as $one_question) {
            if(!array_key_exists($one_question->getId(), $keyvalueanswers)){
                $keyvalueanswers[$one_question->getId()] = null;
            }

            $ans = $one_question->evaluate($keyvalueanswers[$one_question->getId()]);
            $total_score += $ans['score'];

            $score[$one_question->getId()] = $ans['answers'];
        }

        return array('score' => $total_score, 'answers' => $score);
    }

    public function getTotalScore(){
        $q = self::getRepository()->createQuery('e')
            ->innerJoin('e.ExerciseHasExerciseQuestion eheq')
            ->innerJoin('eheq.ExerciseQuestion eq')
            ->innerJoin('eq.Answers ans')
            ->where('e.id = ?', $this->getId())
            ->select("sum(ans.value) as total")
            ->execute();

        return $q->getFirst()->getTotal();
    }

}
